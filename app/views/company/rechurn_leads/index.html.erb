<% content_for :page_title, "Rechurn Leads" %>

<div class="space-y-6">
  <!-- Page Header -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Rechurn Leads</h1>
          <p class="mt-1 text-sm text-gray-600">Manage and reassign leads across your team</p>
        </div>
        <div class="text-right">
          <div class="text-3xl font-bold text-blue-600"><%= @total_leads %></div>
          <div class="text-sm text-gray-500">Total Leads</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Form -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">Filter Leads</h3>
      <p class="mt-1 text-sm text-gray-600">Apply filters to select leads for rechurning</p>
    </div>
    
    <%= form_with url: company_rechurn_leads_path, method: :get, local: true, class: "p-6 space-y-6" do |form| %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Project Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Projects</label>
          <div class="relative">
            <div data-controller="multiselect-dropdown" 
                 data-multiselect-dropdown-placeholder-value="Select projects..."
                 data-multiselect-dropdown-search-placeholder-value="Search projects..."
                 class="relative">
              <div data-action="click->multiselect-dropdown#toggle"
                   data-multiselect-dropdown-target="input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                Select projects...
              </div>
              <div data-multiselect-dropdown-target="dropdown" 
                   class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg">
                <div class="p-2">
                  <input data-multiselect-dropdown-target="searchInput"
                         data-action="input->multiselect-dropdown#search"
                         type="text"
                         placeholder="Search projects..."
                         class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div data-multiselect-dropdown-target="options" class="max-h-48 overflow-y-auto p-2">
                  <% @projects.each do |project| %>
                    <label class="flex items-center px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer rounded">
                      <input type="checkbox" 
                             name="project_ids[]" 
                             value="<%= project.id %>"
                             <%= 'checked' if params[:project_ids]&.include?(project.id.to_s) %>
                             data-action="change->multiselect-dropdown#toggleOption"
                             class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                      <%= project.name %>
                    </label>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Statuses</label>
          <div class="relative">
            <div data-controller="multiselect-dropdown" 
                 data-multiselect-dropdown-placeholder-value="Select statuses..."
                 data-multiselect-dropdown-search-placeholder-value="Search statuses..."
                 class="relative">
              <div data-action="click->multiselect-dropdown#toggle"
                   data-multiselect-dropdown-target="input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                Select statuses...
              </div>
              <div data-multiselect-dropdown-target="dropdown" 
                   class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg">
                <div data-multiselect-dropdown-target="options" class="max-h-48 overflow-y-auto p-2">
                  <% @statuses.each do |status| %>
                    <label class="flex items-center px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer rounded">
                      <input type="checkbox" 
                             name="status_ids[]" 
                             value="<%= status.id %>"
                             <%= 'checked' if params[:status_ids]&.include?(status.id.to_s) %>
                             data-action="change->multiselect-dropdown#toggleOption"
                             class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                      <%= status.name %>
                    </label>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- User Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Assigned To</label>
          <div class="relative">
            <div data-controller="multiselect-dropdown" 
                 data-multiselect-dropdown-placeholder-value="Select users..."
                 data-multiselect-dropdown-search-placeholder-value="Search users..."
                 class="relative">
              <div data-action="click->multiselect-dropdown#toggle"
                   data-multiselect-dropdown-target="input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                Select users...
              </div>
              <div data-multiselect-dropdown-target="dropdown" 
                   class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg">
                <div class="p-2">
                  <input data-multiselect-dropdown-target="searchInput"
                         data-action="input->multiselect-dropdown#search"
                         type="text"
                         placeholder="Search users..."
                         class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div data-multiselect-dropdown-target="options" class="max-h-48 overflow-y-auto p-2">
                  <% @users.each do |user| %>
                    <label class="flex items-center px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer rounded">
                      <input type="checkbox" 
                             name="user_ids[]" 
                             value="<%= user.id %>"
                             <%= 'checked' if params[:user_ids]&.include?(user.id.to_s) %>
                             data-action="change->multiselect-dropdown#toggleOption"
                             class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                      <%= user.name %>
                    </label>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Created At From -->
        <div>
          <%= form.label :created_at_from, "Created From", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.date_field :created_at_from, 
                value: params[:created_at_from], 
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
        </div>

        <!-- Created At Upto -->
        <div>
          <%= form.label :created_at_upto, "Created Upto", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.date_field :created_at_upto, 
                value: params[:created_at_upto], 
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
        </div>

        <!-- Max Rechurns -->
        <div>
          <%= form.label :max_rechurns, "Max Rechurns", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.number_field :max_rechurns, 
                value: params[:max_rechurns], 
                placeholder: "Enter max rechurns", 
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
        </div>
      </div>

      <div class="flex justify-end">
        <%= form.submit "Apply Filters", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
      </div>
    <% end %>
  </div>

  <!-- Results and Assignment Form -->
  <% if params[:project_ids].present? || params[:status_ids].present? || params[:user_ids].present? || params[:created_at_from].present? || params[:created_at_upto].present? || params[:max_rechurns].present? %>
    <div class="bg-white shadow rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Filter Results</h3>
        <p class="mt-1 text-sm text-gray-600">Found <%= @filtered_count %> leads matching your criteria</p>
      </div>
      
      <div class="p-6">
        <% if @filtered_count > 0 %>
          <%= form_with url: perform_rechurn_company_rechurn_leads_path, method: :post, local: true, class: "space-y-6" do |form| %>
            <!-- Hidden fields for filter params -->
            <%= form.hidden_field :project_ids, value: params[:project_ids] %>
            <%= form.hidden_field :status_ids, value: params[:status_ids] %>
            <%= form.hidden_field :user_ids, value: params[:user_ids] %>
            <%= form.hidden_field :created_at_from, value: params[:created_at_from] %>
            <%= form.hidden_field :created_at_upto, value: params[:created_at_upto] %>
            <%= form.hidden_field :max_rechurns, value: params[:max_rechurns] %>
            
            <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-blue-800">Assignment Form</h3>
                  <div class="mt-2 text-sm text-blue-700">
                    <p>Assign <span id="lead-count-display">0</span> leads to <span id="user-display">selected user</span></p>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Lead Count Input -->
              <div>
                <%= form.label :lead_count, "Number of Leads to Assign", class: "block text-sm font-medium text-gray-700 mb-2" do %>
                  Number of Leads to Assign <span class="text-red-500">*</span>
                <% end %>
                <%= form.number_field :lead_count, 
                      min: 1, 
                      max: @filtered_count, 
                      value: [1, @filtered_count].min, 
                      required: true,
                      class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm",
                      id: "lead-count-input" %>
                <p class="mt-1 text-xs text-gray-500">Maximum: <%= @filtered_count %> leads</p>
              </div>

              <!-- Assign User Dropdown -->
              <div>
                <%= form.label :assign_user_id, "Assign to User", class: "block text-sm font-medium text-gray-700 mb-2" do %>
                  Assign to User <span class="text-red-500">*</span>
                <% end %>
                <%= form.select :assign_user_id, 
                      options_from_collection_for_select(@users, :id, :name), 
                      { prompt: "Select a user..." }, 
                      { required: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm",
                        id: "assign-user-select" } %>
              </div>

              <!-- Assign Project Dropdown -->
              <div>
                <%= form.label :assign_project_id, "Assign to Project", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= form.select :assign_project_id, 
                      options_from_collection_for_select(@projects, :id, :name), 
                      { prompt: "Select a project..." }, 
                      { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm",
                        id: "assign-project-select" } %>
              </div>
            </div>

            <div class="flex justify-end">
              <%= form.submit "Rechurn", 
                    class: "inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",
                    data: { 
                      confirm: "Are you sure? This action cannot be undone!!",
                      disable_with: "Processing..."
                    } %>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No leads found</h3>
            <p class="mt-1 text-sm text-gray-500">Try adjusting your filter criteria.</p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>


<script>
// Update the display when lead count or user changes
document.addEventListener('DOMContentLoaded', function() {
  const leadCountInput = document.getElementById('lead-count-input');
  const userSelect = document.getElementById('assign-user-select');
  const leadCountDisplay = document.getElementById('lead-count-display');
  const userDisplay = document.getElementById('user-display');

  function updateDisplay() {
    if (leadCountInput && leadCountDisplay) {
      leadCountDisplay.textContent = leadCountInput.value || '0';
    }
    if (userSelect && userDisplay) {
      const selectedOption = userSelect.options[userSelect.selectedIndex];
      userDisplay.textContent = selectedOption ? selectedOption.text : 'selected user';
    }
  }

  if (leadCountInput) {
    leadCountInput.addEventListener('input', updateDisplay);
  }
  if (userSelect) {
    userSelect.addEventListener('change', updateDisplay);
  }
  
  // Initial update
  updateDisplay();
});
</script>
